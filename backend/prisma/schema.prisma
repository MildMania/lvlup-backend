generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Note: For Railway deployment, this will be automatically set to PostgreSQL
// The switch-env.sh script handles changing this for local/production

model Game {
  id                String             @id @default(cuid())
  name              String
  apiKey            String             @unique
  description       String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  experiments       ABTest[]
  aiInsights        AiInsight[]
  aiQueries         AiQuery[]
  businessEvents    BusinessEvent[]
  checkpoints       Checkpoint[]
  contextMetadata   ContextMetadata[]
  crashLogs         CrashLog[]
  events            Event[]
  playerCheckpoints PlayerCheckpoint[]
  releases          Release[]
  configs           RemoteConfig[]
  sessions          Session[]
  users             User[]

  @@map("games")
}

model User {
  id                String             @id @default(cuid())
  gameId            String
  externalId        String
  deviceId          String?
  platform          String?
  version           String?
  country           String?
  language          String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  aiQueries         AiQuery[]
  events            Event[]
  playerCheckpoints PlayerCheckpoint[]
  sessions          Session[]
  game              Game               @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, externalId])
  @@map("users")
}

model Session {
  id            String    @id @default(cuid())
  gameId        String
  userId        String
  startTime     DateTime  @default(now())
  endTime       DateTime?
  duration      Int?
  lastHeartbeat DateTime? // Track last heartbeat for automatic session closure
  platform      String?
  version       String?
  events        Event[]
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  game          Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId, userId, startTime])
  @@index([gameId, startTime])
  @@index([endTime, lastHeartbeat]) // Index for heartbeat cleanup queries
  @@map("sessions")
}

model Event {
  id         String   @id @default(cuid())
  gameId     String
  userId     String
  sessionId  String?
  eventName  String
  properties Json?
  timestamp  DateTime @default(now())  // Event time (validated client timestamp or server time)
  
  // AB Test assignments - stored directly in event for fast filtering
  abTests    Json?    // { "test_id_1": "variant_a", "test_id_2": "variant_b" }
  
  // Level Funnel tracking - for comparing different level design iterations
  levelFunnel        String?  // e.g., "live_v1", "live_v2", "test_hard"
  levelFunnelVersion Int?     // Incremental version number: 1, 2, 3, etc.
  
  // Event metadata (like GameAnalytics)
  eventUuid        String?   // Unique event identifier from client
  clientTs         BigInt?   // Client-side Unix timestamp (milliseconds)
  serverReceivedAt DateTime? // Server timestamp when event was received
  
  // Device & Platform info
  platform      String?  // e.g., "android", "ios", "webgl"
  osVersion     String?  // e.g., "android 13", "iOS 16.0"
  manufacturer  String?  // e.g., "TECNO", "Apple"
  device        String?  // e.g., "TECNO BG6", "iPhone 14"
  deviceId      String?  // Unique device identifier
  
  // App info
  appVersion    String?  // e.g., "0.0.3"
  appBuild      String?  // e.g., "30087"
  bundleId      String?  // e.g., "com.mildmania.packperfect"
  engineVersion String?  // e.g., "unity 2022.3.62"
  sdkVersion    String?  // e.g., "unity 1.0.0"
  
  // Network & Additional
  connectionType String?  // e.g., "wifi", "wwan", "offline"
  sessionNum     Int?     // Session number for this user
  appSignature   String?  // Android app signature
  channelId      String?  // e.g., "com.android.vending"
  
  // Geographic location
  country        String?  // ISO country code, e.g., "US", "TR"
  countryCode    String?  // ISO 3166-1 alpha-2, e.g., "US"
  region         String?  // Region/State, e.g., "California", "Istanbul"
  city           String?  // City name, e.g., "San Francisco", "Istanbul"
  latitude       Float?   // Latitude coordinate
  longitude      Float?   // Longitude coordinate
  timezone       String?  // IANA timezone, e.g., "America/Los_Angeles"
  
  session    Session? @relation(fields: [sessionId], references: [id])
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  game       Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId, eventName, timestamp])
  @@index([userId, timestamp])
  @@index([gameId, platform, timestamp])
  @@index([gameId, appVersion, timestamp])
  @@index([gameId, country, timestamp])
  @@index([gameId, countryCode, timestamp])
  @@map("events")
}

model RemoteConfig {
  id          String   @id @default(cuid())
  gameId      String
  key         String
  value       Json
  environment String   @default("production")
  enabled     Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, key, environment])
  @@map("remote_configs")
}

model ABTest {
  id           String           @id @default(cuid())
  gameId       String
  name         String
  description  String?
  status       TestStatus       @default(DRAFT)
  trafficSplit Float            @default(0.5)
  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  game         Game             @relation(fields: [gameId], references: [id], onDelete: Cascade)
  assignments  TestAssignment[]
  variants     TestVariant[]

  @@map("ab_tests")
}

model TestVariant {
  id          String           @id @default(cuid())
  testId      String
  name        String
  description String?
  config      Json
  weight      Float            @default(0.5)
  assignments TestAssignment[]
  test        ABTest           @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@map("test_variants")
}

model TestAssignment {
  id         String      @id @default(cuid())
  testId     String
  variantId  String
  userId     String
  assignedAt DateTime    @default(now())
  variant    TestVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  test       ABTest      @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([testId, userId])
  @@map("test_assignments")
}

model Checkpoint {
  id                String             @id @default(cuid())
  gameId            String
  name              String
  description       String?
  type              String
  tags              Json?
  order             Int?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  game              Game               @relation(fields: [gameId], references: [id], onDelete: Cascade)
  playerCheckpoints PlayerCheckpoint[]

  @@unique([gameId, name])
  @@map("checkpoints")
}

model PlayerCheckpoint {
  id           String     @id @default(cuid())
  gameId       String
  userId       String
  checkpointId String
  timestamp    DateTime   @default(now())
  metadata     Json?
  checkpoint   Checkpoint @relation(fields: [checkpointId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  game         Game       @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, checkpointId])
  @@index([gameId, userId, timestamp])
  @@map("player_checkpoints")
}

model Release {
  id          String           @id @default(cuid())
  version     String           @unique
  releaseDate DateTime
  description String?
  gameId      String?
  rolloutType String           @default("full")
  status      String           @default("active")
  tags        Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  features    ReleaseFeature[]
  game        Game?            @relation(fields: [gameId], references: [id])

  @@map("releases")
}

model ReleaseFeature {
  id               String    @id @default(cuid())
  releaseId        String
  name             String
  description      String?
  type             String
  expectedImpact   String?
  impactMetrics    Json?
  rolloutStartDate DateTime?
  rolloutEndDate   DateTime?
  createdAt        DateTime  @default(now())
  release          Release   @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  @@map("release_features")
}

model BusinessEvent {
  id          String    @id @default(cuid())
  name        String
  description String?
  type        String
  startDate   DateTime
  endDate     DateTime?
  gameId      String?
  impact      String?
  metadata    Json?
  tags        Json?
  createdAt   DateTime  @default(now())
  game        Game?     @relation(fields: [gameId], references: [id])

  @@map("business_events")
}

model AiQuery {
  id           String      @id @default(cuid())
  query        String
  queryType    String
  context      Json?
  response     String?
  responseType String?
  confidence   Float?
  gameId       String?
  userId       String?
  createdAt    DateTime    @default(now())
  insights     AiInsight[]
  user         User?       @relation(fields: [userId], references: [id])
  game         Game?       @relation(fields: [gameId], references: [id])

  @@map("ai_queries")
}

model AiInsight {
  id          String   @id @default(cuid())
  queryId     String?
  title       String
  description String
  type        String
  confidence  Float
  gameId      String?
  dateRange   Json?
  metrics     Json?
  metadata    Json?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  query       AiQuery? @relation(fields: [queryId], references: [id])
  game        Game?    @relation(fields: [gameId], references: [id])

  @@map("ai_insights")
}

model ContextMetadata {
  id          String    @id @default(cuid())
  type        String
  description String
  dateRange   Json?
  gameId      String?
  metadata    Json
  computedAt  DateTime  @default(now())
  validUntil  DateTime?
  status      String    @default("active")
  game        Game?     @relation(fields: [gameId], references: [id])

  @@map("context_metadata")
}

model CrashLog {
  id            String         @id @default(cuid())
  gameId        String
  userId        String?
  sessionId     String?
  
  // Crash details
  crashType     String         // "exception", "crash", "anr"
  severity      String         @default("ERROR") // "LOW", "MEDIUM", "HIGH", "CRITICAL", "ERROR", "WARNING"
  message       String
  stackTrace    String
  exceptionType String?        // e.g., "NullReferenceException", "IndexOutOfRangeException"
  
  // Device & Platform info
  platform      String?
  osVersion     String?
  manufacturer  String?
  device        String?
  deviceId      String?
  
  // App info
  appVersion    String?
  appBuild      String?
  bundleId      String?
  engineVersion String?
  sdkVersion    String?
  
  // Context
  country       String?
  connectionType String?
  memoryUsage   Int?           // Memory usage in bytes (using Int instead of BigInt for SQLite)
  batteryLevel  Float?         // Battery level 0-1
  diskSpace     Int?           // Available disk space in bytes (using Int instead of BigInt for SQLite)
  
  // Additional metadata
  breadcrumbs   String?        // JSON string of breadcrumbs leading to crash
  customData    String?        // JSON string of custom key-value pairs
  
  timestamp     DateTime       @default(now())
  resolved      Boolean        @default(false)
  resolvedAt    DateTime?
  
  game          Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId, timestamp])
  @@index([gameId, platform, timestamp])
  @@index([gameId, appVersion, timestamp])
  @@index([gameId, crashType, timestamp])
  @@index([gameId, severity, timestamp])
  @@map("crash_logs")
}

enum TestStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
}


